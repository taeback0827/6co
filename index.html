<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>6ì¤‘ëŒ€ ì¶œíƒ€ìœ¨ ê´€ë¦¬ (ì‹¤ì‹œê°„)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* CSS ìŠ¤íƒ€ì¼ì€ ì´ì „ê³¼ ë™ì¼í•˜ë¯€ë¡œ ìƒëµí•©ë‹ˆë‹¤. */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #f4f7f6; color: #333; }
        .app-container { max-width: 1400px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { text-align: center; font-size: 2.5em; color: #1a237e; margin-bottom: 20px; }
        .main-content { display: flex; gap: 20px; }
        .calendar-container { flex: 3; }
        .controls-container { flex: 2; display: flex; flex-direction: column; gap: 20px; }
        .card { background: #ffffff; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0; }
        h2 { font-size: 1.4em; color: #3949ab; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 0; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .input-group input, .input-group select { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; }
        .member-item { display: flex; align-items: center; margin-bottom: 10px; gap: 10px; }
        .member-item input { flex-grow: 1; }
        button { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background-color 0.2s; }
        .btn-add { background-color: #43a047; color: white; } .btn-add:hover { background-color: #388e3c; }
        .btn-remove { background-color: #e53935; color: white; } .btn-remove:hover { background-color: #d32f2f; }
        #leave-list ul { list-style: none; padding: 0; margin: 0; max-height: 400px; overflow-y: auto; }
        #leave-list li { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; font-size: 0.9em; }
        .calendar-header { display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 15px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day-name { font-weight: bold; text-align: center; padding: 5px; background: #e8eaf6; border-radius: 4px; }
        .calendar-day { position: relative; border: 1px solid #e0e0e0; height: 120px; padding: 5px; border-radius: 4px; background-color: #fff; overflow-y: auto; }
        .calendar-day.other-month { background-color: #f5f5f5; color: #aaa; }
        .day-number { font-weight: bold; }
        .calendar-day.saturday .day-number { color: #1e88e5; } .calendar-day.sunday .day-number { color: #e53935; }
        .leave-rate { position: absolute; bottom: 5px; right: 5px; font-size: 0.8em; font-weight: bold; color: #555; }
        .leave-entry { font-size: 0.75em; background-color: #c5cae9; border-radius: 3px; padding: 2px 4px; margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .warning { background-color: #ffcdd2 !important; }
        .warning .leave-rate { color: #c62828; font-size: 0.9em; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 400px; border-radius: 8px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ccc; padding-bottom: 10px; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; }
        .close-button { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-footer { text-align: right; margin-top: 20px; }
        .btn-save { background-color: #1976d2; color: white; } .btn-save:hover { background-color: #1565c0; }
    </style>
</head>
<body>

    <div class="app-container">
        <h1>ğŸ“… 6ì¤‘ëŒ€ ì¶œíƒ€ìœ¨ ê´€ë¦¬ (ì‹¤ì‹œê°„)</h1>
        <div class="main-content">
            <div class="calendar-container card">
                 <div class="calendar-header">
                    <select id="year-select"></select>
                    <select id="month-select"></select>
                </div>
                <div class="calendar-grid" id="calendar-days-header">
                    <div class="calendar-day-name" style="color: #e53935;">ì¼</div><div class="calendar-day-name">ì›”</div><div class="calendar-day-name">í™”</div><div class="calendar-day-name">ìˆ˜</div><div class="calendar-day-name">ëª©</div><div class="calendar-day-name">ê¸ˆ</div><div class="calendar-day-name" style="color: #1e88e5;">í† </div>
                </div>
                <div class="calendar-grid" id="calendar-grid"></div>
            </div>
            <div class="controls-container">
                <div class="card">
                    <h2>ì¤‘ëŒ€ì› ê´€ë¦¬</h2>
                    <p style="font-size:0.9em; color:#555; margin-top:0;">* í˜„ì¬ ì¤‘ëŒ€ì› ìˆ˜: <strong id="current-member-count">0</strong>ëª…</p>
                    <div class="input-group" style="display:flex; gap:10px;">
                        <input type="text" id="new-member-name" placeholder="ìƒˆ ì¤‘ëŒ€ì› ì´ë¦„">
                        <button id="add-member-button" class="btn-add">ì¶”ê°€</button>
                    </div>
                    <div id="member-list"></div>
                </div>
                <div class="card">
                    <h2>ì¶œíƒ€ ëª©ë¡</h2>
                    <div id="leave-list"><ul></ul></div>
                </div>
            </div>
        </div>
    </div>

    <div id="add-leave-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">ì¶œíƒ€ ì¶”ê°€</h2>
                <span class="close-button">&times;</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modal-member-id">
                <div class="input-group">
                    <label for="leave-type">ì¶œíƒ€ ìœ í˜•:</label>
                    <select id="leave-type">
                        <option value="íœ´ê°€">íœ´ê°€ (ìµœëŒ€ 15ì¼)</option>
                        <option value="ì™¸ë°•">ì™¸ë°• (1ë°• 2ì¼)</option>
                        <option value="ì™¸ì¶œ">ì™¸ì¶œ (1ì¼)</option>
                    </select>
                </div>
                <div class="input-group"><label for="start-date">ì‹œì‘ì¼:</label><input type="date" id="start-date"></div>
                <div class="input-group"><label for="end-date">ì¢…ë£Œì¼:</label><input type="date" id="end-date"></div>
            </div>
            <div class="modal-footer"><button id="save-leave-button" class="btn-save">ì €ì¥</button></div>
        </div>
    </div>

<script>
    // 2. Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
    const SUPABASE_URL = 'YOUR_SUPABASE_URL'; // â—€ï¸ ì—¬ê¸°ì— ìì‹ ì˜ Supabase URLì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY'; // â—€ï¸ ì—¬ê¸°ì— ìì‹ ì˜ Supabase anon keyë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
    const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    document.addEventListener('DOMContentLoaded', () => {
        // ì „ì—­ ìƒíƒœ ë³€ìˆ˜ (DBì—ì„œ ë¶ˆëŸ¬ì˜¨ ë°ì´í„°ë¥¼ ë‹´ì„ ê³³)
        let members = [];
        let leaves = [];
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();

        // DOM ìš”ì†Œ ì°¸ì¡°
        const memberListDiv = document.getElementById('member-list');
        const leaveListUl = document.querySelector('#leave-list ul');
        const calendarGrid = document.getElementById('calendar-grid');
        const yearSelect = document.getElementById('year-select');
        const monthSelect = document.getElementById('month-select');
        const currentMemberCountSpan = document.getElementById('current-member-count');
        const addMemberButton = document.getElementById('add-member-button');
        const newMemberNameInput = document.getElementById('new-member-name');
        
        // ëª¨ë‹¬ ê´€ë ¨ ìš”ì†Œ
        const modal = document.getElementById('add-leave-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMemberIdInput = document.getElementById('modal-member-id');
        const closeModalButton = document.querySelector('.close-button');
        const saveLeaveButton = document.getElementById('save-leave-button');
        const leaveTypeSelect = document.getElementById('leave-type');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');

        // --- ë°ì´í„°ë² ì´ìŠ¤ í†µì‹  í•¨ìˆ˜ë“¤ ---
        async function fetchAndRenderAll() {
            // 1. DBì—ì„œ ì¤‘ëŒ€ì›ê³¼ ì¶œíƒ€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const { data: memberData, error: memberError } = await supabase.from('members').select('*').order('name');
            const { data: leaveData, error: leaveError } = await supabase.from('leaves').select('*');

            if (memberError) console.error('Error fetching members:', memberError);
            if (leaveError) console.error('Error fetching leaves:', leaveError);
            
            // 2. ê°€ì ¸ì˜¨ ë°ì´í„°ë¡œ ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
            members = memberData || [];
            leaves = leaveData || [];
            
            // 3. í™”ë©´ ì „ì²´ ë Œë”ë§
            renderAll();
        }

        async function addMember() {
            const name = newMemberNameInput.value.trim();
            if (!name) {
                alert('ì¤‘ëŒ€ì› ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            const { error } = await supabase.from('members').insert([{ name: name }]);
            if (error) console.error('Error adding member:', error);
            else newMemberNameInput.value = ''; // ì„±ê³µ ì‹œ ì…ë ¥ì°½ ë¹„ìš°ê¸°
            // ì‹¤ì‹œê°„ ê¸°ëŠ¥ì´ ìë™ìœ¼ë¡œ í™”ë©´ì„ ê°±ì‹ í•´ì¤ë‹ˆë‹¤.
        }

        async function deleteMember(memberId) {
            if (confirm('ì´ ì¤‘ëŒ€ì›ì„ ì‚­ì œí•˜ë©´ ê´€ë ¨ëœ ëª¨ë“  ì¶œíƒ€ê¸°ë¡ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤. ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                const { error } = await supabase.from('members').delete().eq('id', memberId);
                if (error) console.error('Error deleting member:', error);
            }
        }

        async function saveLeave() {
            const member_id = parseInt(modalMemberIdInput.value);
            const type = leaveTypeSelect.value;
            const start_date = startDateInput.value;
            const end_date = endDateInput.value;

            if (!start_date || !end_date) { alert('ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
            if (new Date(end_date) < new Date(start_date)) { alert('ì¢…ë£Œì¼ì€ ì‹œì‘ì¼ë³´ë‹¤ ì´ì „ì¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }

            const { error } = await supabase.from('leaves').insert([{ member_id, type, start_date, end_date }]);
            if (error) console.error('Error saving leave:', error);
            else closeModal();
        }
        
        async function deleteLeave(leaveId) {
            if (confirm('ì´ ì¶œíƒ€ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                const { error } = await supabase.from('leaves').delete().eq('id', leaveId);
                if (error) console.error('Error deleting leave:', error);
            }
        }

        // --- ì‹¤ì‹œê°„ êµ¬ë… ì„¤ì • ---
        function setupRealtimeSubscriptions() {
            const channel = supabase.channel('public-tables-channel');
            channel
                .on('postgres_changes', { event: '*', schema: 'public', table: 'members' }, payload => {
                    console.log('Member change detected:', payload);
                    fetchAndRenderAll();
                })
                .on('postgres_changes', { event: '*', schema: 'public', table: 'leaves' }, payload => {
                    console.log('Leave change detected:', payload);
                    fetchAndRenderAll();
                })
                .subscribe();
            console.log("ì‹¤ì‹œê°„ ë™ê¸°í™”ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        // --- í™”ë©´ ë Œë”ë§ í•¨ìˆ˜ë“¤ (DB ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ ë™ì‘) ---
        function renderAll() {
            renderMemberList();
            renderLeaveList();
            renderCalendar();
            currentMemberCountSpan.textContent = members.length;
        }

        function renderMemberList() {
            memberListDiv.innerHTML = '';
            members.forEach(member => {
                const memberItem = document.createElement('div');
                memberItem.className = 'member-item';
                // ì´ë¦„ í‘œì‹œ (ìˆ˜ì • ê¸°ëŠ¥ì€ ë³µì¡ë„ ì¦ê°€ë¡œ ì œê±°, í•„ìš”ì‹œ ì¶”ê°€ ê°€ëŠ¥)
                const nameSpan = document.createElement('span');
                nameSpan.textContent = member.name;
                nameSpan.style.flexGrow = '1';

                const addButton = document.createElement('button');
                addButton.textContent = 'ì¶œíƒ€ ì¶”ê°€';
                addButton.className = 'btn-add';
                addButton.addEventListener('click', () => openModal(member.id));
                
                const removeButton = document.createElement('button');
                removeButton.textContent = 'ì‚­ì œ';
                removeButton.className = 'btn-remove';
                removeButton.addEventListener('click', () => deleteMember(member.id));

                memberItem.appendChild(nameSpan);
                memberItem.appendChild(addButton);
                memberItem.appendChild(removeButton);
                memberListDiv.appendChild(memberItem);
            });
        }
        
        function renderLeaveList() {
            leaveListUl.innerHTML = '';
            leaves.sort((a, b) => new Date(a.start_date) - new Date(b.start_date));
            leaves.forEach(leave => {
                const li = document.createElement('li');
                const member = members.find(m => m.id === leave.member_id);
                if (!member) return; // í˜¹ì‹œ ëª¨ë¥¼ ì˜¤ë¥˜ ë°©ì§€
                
                const infoDiv = document.createElement('div');
                infoDiv.textContent = `[${member.name}] ${leave.type}: ${leave.start_date} ~ ${leave.end_date}`;
                
                const removeButton = document.createElement('button');
                removeButton.textContent = 'ì œê±°';
                removeButton.className = 'btn-remove';
                removeButton.addEventListener('click', () => deleteLeave(leave.id));

                li.appendChild(infoDiv);
                li.appendChild(removeButton);
                leaveListUl.appendChild(li);
            });
        }

        function renderCalendar() {
             calendarGrid.innerHTML = '';
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDayOfWeek = firstDay.getDay(); 
            for (let i = 0; i < startDayOfWeek; i++) {
                calendarGrid.appendChild(document.createElement('div')).className = 'calendar-day other-month';
            }
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                const currentDate = new Date(currentYear, currentMonth, day);
                const dayOfWeek = currentDate.getDay();
                dayCell.className = 'calendar-day';
                if (dayOfWeek === 0) dayCell.classList.add('sunday');
                if (dayOfWeek === 6) dayCell.classList.add('saturday');
                dayCell.innerHTML = `<div class="day-number">${day}</div>`;

                const leavesOnThisDay = getLeavesForDate(currentDate);
                if (members.length > 0) {
                    const leaveRate = (leavesOnThisDay.length / members.length) * 100;
                    dayCell.innerHTML += `<div class="leave-rate">${leaveRate.toFixed(0)}%</div>`;
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                    if ((!isWeekend && leaveRate > 20) || (isWeekend && leaveRate > 35)) {
                        dayCell.classList.add('warning');
                    }
                }
                leavesOnThisDay.forEach(leave => {
                    const member = members.find(m => m.id === leave.member_id);
                    if (member) dayCell.innerHTML += `<div class="leave-entry">${member.name}: ${leave.type}</div>`;
                });
                calendarGrid.appendChild(dayCell);
            }
        }
        
        function getLeavesForDate(date) {
            const dateString = date.toISOString().split('T')[0];
            return leaves.filter(leave => dateString >= leave.start_date && dateString <= leave.end_date);
        }

        // --- ìœ í‹¸ë¦¬í‹° ë° ëª¨ë‹¬ í•¨ìˆ˜ë“¤ ---
        function openModal(memberId) {
            const member = members.find(m => m.id === memberId);
            modalTitle.textContent = `${member.name} ì¶œíƒ€ ì¶”ê°€`;
            modalMemberIdInput.value = memberId;
            startDateInput.value = new Date().toISOString().split('T')[0];
            endDateInput.value = '';
            leaveTypeSelect.value = 'íœ´ê°€';
            updateEndDate();
            modal.style.display = 'block';
        }
        function closeModal() { modal.style.display = 'none'; }
        
        function updateEndDate() {
            const type = leaveTypeSelect.value;
            const startDateStr = startDateInput.value;
            if (!startDateStr) { endDateInput.value = ''; return; }
            const startDate = new Date(startDateStr);
            if (type === 'ì™¸ë°•') {
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 1);
                endDateInput.value = endDate.toISOString().split('T')[0];
                endDateInput.readOnly = true;
            } else if (type === 'ì™¸ì¶œ') {
                endDateInput.value = startDateStr;
                endDateInput.readOnly = true;
            } else {
                endDateInput.readOnly = false;
            }
        }

        function populateYearSelect() {
            const year = new Date().getFullYear();
            for (let i = year - 2; i <= year + 2; i++) {
                yearSelect.add(new Option(`${i}ë…„`, i));
            }
            yearSelect.value = currentYear;
        }

        function populateMonthSelect() {
            for (let i = 0; i < 12; i++) {
                monthSelect.add(new Option(`${i + 1}ì›”`, i));
            }
            monthSelect.value = currentMonth;
        }

        // --- ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™” ---
        function initialize() {
            populateYearSelect();
            populateMonthSelect();

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            yearSelect.addEventListener('change', () => { currentYear = parseInt(yearSelect.value); renderCalendar(); });
            monthSelect.addEventListener('change', () => { currentMonth = parseInt(monthSelect.value); renderCalendar(); });
            addMemberButton.addEventListener('click', addMember);
            closeModalButton.addEventListener('click', closeModal);
            window.addEventListener('click', (event) => { if (event.target == modal) closeModal(); });
            leaveTypeSelect.addEventListener('change', updateEndDate);
            startDateInput.addEventListener('change', updateEndDate);
            saveLeaveButton.addEventListener('click', saveLeave);
            
            // ë°ì´í„° ë¡œë”© ë° ì‹¤ì‹œê°„ êµ¬ë… ì‹œì‘
            fetchAndRenderAll();
            setupRealtimeSubscriptions();
        }

        initialize();
    });
</script>

</body>
</html>